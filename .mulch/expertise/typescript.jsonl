{"type":"convention","content":"Overstory has zero runtime npm dependencies. Uses only Bun built-in APIs: bun:sqlite for databases, Bun.spawn for subprocesses, Bun.file for filesystem. CLI tools (bd, mulch) are invoked via Bun.spawn, not imported.","classification":"foundational","recorded_at":"2026-02-12T15:18:17.008Z","tags":["bun","dependencies","convention"],"id":"mx-ef1236"}
{"type":"convention","content":"noUncheckedIndexedAccess enabled, noExplicitAny enforced via Biome. Tab indentation, 100 char line width. Module: ESNext with bundler resolution. allowImportingTsExtensions since Bun runs TS directly (no build step).","classification":"foundational","recorded_at":"2026-02-12T15:18:20.350Z","tags":["tsconfig","biome","strict"],"id":"mx-2ce43d"}
{"type":"pattern","name":"Bun.spawn Subprocess Pattern","description":"Use Bun.spawn(cmd, { cwd, stdout: 'pipe', stderr: 'pipe' }) for subprocesses. Read output: const stdout = await new Response(proc.stdout).text(). Check exit: const exitCode = await proc.exited. All CLI wrappers (bd, mulch, tmux, git) follow this pattern.","classification":"foundational","recorded_at":"2026-02-12T15:24:33.663Z","tags":["bun","subprocess","spawn"],"id":"mx-14d62a"}
{"type":"pattern","name":"bun:sqlite Synchronous Pattern","description":"bun:sqlite is synchronous. Use Database class from 'bun:sqlite'. Enable WAL mode: db.exec('PRAGMA journal_mode=WAL'). Set busy_timeout: db.exec('PRAGMA busy_timeout=5000'). Use db.prepare() for prepared statements. db.query().all() for SELECT, db.run() for INSERT/UPDATE. No async/await needed for DB ops.","classification":"foundational","recorded_at":"2026-02-12T15:24:35.750Z","tags":["sqlite","database","sync"],"id":"mx-a64ac9"}
{"type":"convention","content":"Biome enforces: template literals over string concat, sorted imports (by path alphabetically), specific formatting for error constructor args (inline when short). Always run biome check after writing new files.","classification":"tactical","recorded_at":"2026-02-12T15:40:01.052Z","tags":["biome","formatting","lint"],"id":"mx-d00668"}
{"type":"pattern","name":"hooks-deployer test patterns","description":"hooks-deployer tests: Use Bun.file().exists() to verify file creation, JSON.parse on written content to validate structure and individual hook types by key. For write-failure error paths, use /dev/null/impossible-path as worktree path to trigger mkdir failure, then assert the thrown error is instanceof AgentError with correct agentName and code fields.","classification":"tactical","recorded_at":"2026-02-12T15:56:07.848Z","id":"mx-b90d09"}
{"type":"convention","content":"All JSON files written via Bun.write must include a trailing newline: `${JSON.stringify(data, null, '\\t')}\\n`. Biome enforces trailing newlines, and omitting them causes lint failures on generated/runtime files like sessions.json. Apply consistently across all write sites â€” grep for JSON.stringify to find them all.","classification":"tactical","recorded_at":"2026-02-12T16:47:21.468Z","id":"mx-24764f"}
{"type":"pattern","name":"Extract pure functions for testability","description":"Testing embedded logic in large functions: Extract pure computation into an exported function with injectable dependencies (e.g., injectable 'now' timestamp). This avoids mock.module (which leaks globally across bun test files) and enables deterministic, fast unit tests. Applied to stagger delay logic in sling.ts: extracted calculateStaggerDelay(staggerDelayMs, activeSessions, now) as a pure function.","classification":"tactical","recorded_at":"2026-02-12T16:52:50.749Z","id":"mx-35be18"}
{"type":"failure","description":"bun:test mock.module() is process-global and leaks across all test files run in the same bun test invocation. Mocking a module like ../src/config.ts in one test file causes other test files that import the same module to get the mocked version, causing 73+ test failures.","resolution":"Avoid mock.module entirely; instead extract testable pure functions or use spyOn for instance methods.","classification":"tactical","recorded_at":"2026-02-12T16:53:02.407Z","id":"mx-56558b"}
{"type":"decision","title":"Adopt 'never mock what you can use for real' testing philosophy","rationale":"mock.module() leaks across test files (mx-56558b). Real implementations catch actual parsing bugs, command construction errors, and integration issues that mocks hide. 8 of 12 test files already use real implementations successfully (temp dirs, real SQLite). Only 4 files need refactoring.","classification":"tactical","recorded_at":"2026-02-12T16:56:41.784Z","id":"mx-252b16"}
{"type":"convention","content":"Tests are colocated with source files in src/. Each test file lives alongside its source: e.g., src/config.ts has src/config.test.ts, src/mail/store.ts has src/mail/store.test.ts. The tsconfig.json include is just [\"src/**/*.ts\"]. The old __tests__/ directory pattern is deprecated.","classification":"tactical","recorded_at":"2026-02-12T17:01:03.951Z","id":"mx-c0c68d"}
